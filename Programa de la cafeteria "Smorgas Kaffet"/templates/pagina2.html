<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Nueva Cuenta – Smörgås Kaffet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* Caja amarilla similar al diseño base */
    :root{
      --bg-sky:#9fd0ff; --panel-yellow:#fff59d; --primary-blue:#1e88e5;
      --danger-red:#e85d5d; --text-dark:#2b2d2f; --shadow:0 8px 24px rgba(0,0,0,.12);
    }
    body{ background:var(--bg-sky); }
    .wrap{ max-width:920px; margin:48px auto; background:var(--panel-yellow);
           border-radius:18px; padding:28px 26px; box-shadow:var(--shadow); }
    .cat-title{ font-weight:700; margin:.25rem 0 .4rem; }
    .btn-add{ background:var(--primary-blue); color:#fff; border:none; font-weight:600; border-radius:10px; }
    .btn-add:hover{ filter:brightness(.95); color:#fff;}

    /* Modal estilizado para que coincida con el tema */
    .modal-header{ background:var(--panel-yellow); border-bottom:1px solid rgba(0,0,0,.08); }
    .modal-title{ font-weight:700; color:var(--text-dark); }
    .modal-content{ border-radius:16px; box-shadow:var(--shadow); }
    .btn-modal-ok{ background:var(--primary-blue); border:none; }
  </style>
</head>
<body>

<!-- Mensajes flash -->
<div class="container mt-3" style="max-width:920px;">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show shadow-sm" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}
</div>

<div class="wrap">
  <h3 class="text-center mb-2">Nueva Cuenta</h3>
  <!-- Mostrar usuario/rol arriba para pruebas -->
  <div class="text-center text-muted mb-3">
    Usuario: <strong>{{ usuario }}</strong> — Rol: <strong>{{ rol }}</strong>
    <a class="btn btn-sm btn-outline-dark ms-3" href="{{ url_for('logout') }}">Cerrar sesión</a>
  </div>

  <!-- Form principal: POST a /add -->
  <form id="cuentaForm" method="post" action="{{ url_for('add') }}">
    <div class="row g-3">
      <!-- Mesa: solo 100..108 -->
      <div class="col-md-4">
        <label class="form-label">Mesa</label>
        <select class="form-select" name="id_mesa" required>
          <option value="" selected>Selecciona mesa…</option>
          {% for m in range(100,109) %}<option value="{{ m }}">{{ m }}</option>{% endfor %}
        </select>
      </div>
      <!-- Fecha: mínima hoy (variable 'hoy' enviada por app.py) -->
      <div class="col-md-3">
        <label class="form-label">Fecha</label>
        <input type="date" class="form-control" name="fecha" value="{{ hoy }}" min="{{ hoy }}" max="{{ hoy }}" required>
      </div>
    </div>

    <!-- Menú por categorías (catálogo armado en app.py) -->
    <div class="mt-4">
      <label class="form-label">Menú</label>
      {% for categoria, items in catalogo.items() %}
      <div class="row g-2 mb-2">
        <div class="col-12 cat-title">{{ categoria }}</div>
        <div class="col-md-7">
          <!-- Select con opciones producto: lleva data-id y data-precio para JS -->
          <select class="form-select menu-select">
            <option value="" data-id="" data-precio="0" selected>Selecciona {{ categoria|lower }}…</option>
            {% for p in items %}
              <option value="{{ p.nombre }}" data-id="{{ p.id }}" data-precio="{{ '%.2f'|format(p.precio) }}">
                {{ p.nombre }} — ${{ '%.2f'|format(p.precio) }}
              </option>
            {% endfor %}
          </select>
        </div>
        <!-- Cantidad (con límites 1..50) -->
        <div class="col-md-3">
          <input type="number" min="1" max="50" value="1" class="form-control qty" placeholder="Cantidad">
        </div>
        <!-- Botón para añadir la línea a la tabla inferior -->
        <div class="col-md-2 d-grid">
          <button type="button" class="btn btn-add add-line">Añadir</button>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Modo de entrega: radio 1/2 -->
    <div class="mt-3">
      <label class="form-label d-block">Modo de entrega</label>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="id_modo_entrega" value="1" required>
        <label class="form-check-label">Llevar</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="id_modo_entrega" value="2" required>
        <label class="form-check-label">Comedor</label>
      </div>
    </div>

    <!-- Tabla del pedido que se está armando (solo front-end) -->
    <div class="mt-4">
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr><th>#</th><th>Producto</th><th>Cantidad</th><th>Precio</th><th>Subtotal</th><th>Acciones</th></tr>
          </thead>
          <tbody id="tbodyDetalle"></tbody>
          <tfoot>
            <tr>
              <td colspan="4" class="text-end fw-bold">Total:</td>
              <td id="impTotal" class="fw-bold">$0.00</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <!-- Campo oculto donde se serializa el detalle como JSON para el backend -->
    <input type="hidden" name="detalles" id="detallesInput">

    <div class="d-grid gap-2 mt-3">
      <button type="submit" class="btn btn-primary">Enviar Cuenta</button>
      <a href="{{ url_for('index') }}" class="btn btn-secondary">Cancelar</a>
    </div>
  </form>
</div>

<!-- Modal informativo (reemplaza alert) -->
<div class="modal fade" id="infoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Aviso</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <p id="infoModalMsg" class="mb-0">Mensaje</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-modal-ok" data-bs-dismiss="modal">Aceptar</button>
      </div>
    </div>
  </div>
</div>

<!-- JS Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // ====== Utilidad para mostrar modal bonito en vez de alert() ======
  const infoModalEl = document.getElementById('infoModal');
  const infoModalMsg = document.getElementById('infoModalMsg');
  const infoModal = new bootstrap.Modal(infoModalEl);
  function showMsg(text){ infoModalMsg.textContent = text; infoModal.show(); }

  // ===== Validar inputs de cantidad en los selects de categoría (1..50) =====
  document.querySelectorAll(".qty").forEach(input=>{
    const MIN=1, MAX=50;
    input.addEventListener("input", ()=>{
      let v=parseInt(input.value,10);
      if (isNaN(v)) return;
      if (v<MIN) input.value=MIN;
      if (v>MAX) input.value=MAX;
    });
    input.addEventListener("blur", ()=>{
      let v=parseInt(input.value,10);
      if (isNaN(v) || v<MIN) input.value=MIN;
      if (v>MAX) input.value=MAX;
    });
  });

  // ===== Lógica del detalle (solo en front): arreglo 'detalle' + render =====
  const tbody = document.getElementById("tbodyDetalle");
  const impTotal = document.getElementById("impTotal");
  const detallesInput = document.getElementById("detallesInput");
  let detalle = [];

  // Recalcula la tabla y total cada vez que hay cambios
  function recalc(){
    tbody.innerHTML = "";
    let total=0;
    detalle.forEach((d,i)=>{
      let sub = d.precio*d.cantidad; total+=sub;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${d.nombre}</td>
        <td><input type="number" min="1" max="50" value="${d.cantidad}" class="form-control form-control-sm qty-edit"></td>
        <td><input type="number" step="0.01" min="0.01" max="10000" value="${d.precio.toFixed(2)}" class="form-control form-control-sm price-edit"></td>
        <td>$${sub.toFixed(2)}</td>
        <td><button type="button" class="btn btn-sm btn-outline-danger del">Quitar</button></td>`;
      // Validadores al editar cantidad/precio dentro de la tabla
      tr.querySelector(".qty-edit").addEventListener("input", e=>{
        let v = parseInt(e.target.value,10);
        if (isNaN(v) || v<1) v=1; if (v>50) v=50; d.cantidad=v; recalc();
      });
      tr.querySelector(".price-edit").addEventListener("input", e=>{
        let v = parseFloat(e.target.value); if(!isFinite(v) || v<0.01) v=0.01; if (v>10000) v=10000;
        d.precio=v; recalc();
      });
      // Quitar renglón
      tr.querySelector(".del").addEventListener("click", ()=>{
        detalle.splice(i,1); recalc();
      });
      tbody.appendChild(tr);
    });
    // Mostrar total y actualizar JSON oculto
    impTotal.textContent = "$"+total.toFixed(2);
    detallesInput.value = JSON.stringify(detalle);
  }

  // Botón "Añadir" en cada categoría: inserta un renglón al arreglo 'detalle'
  document.querySelectorAll(".add-line").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const row = btn.closest(".row");
      const sel = row.querySelector(".menu-select");
      const qty = row.querySelector(".qty");
      const opt = sel.selectedOptions[0];
      const idp = parseInt(opt.dataset.id, 10);
      const nombre = opt.value;
      const precio = parseFloat(opt.dataset.precio || "0");
      const cant = parseInt(qty.value || "1",10);

      if (!idp || !nombre || precio<=0 || !(1<=cant && cant<=50)) {
        showMsg("Selecciona producto y cantidad válida.");
        return;
      }
      detalle.push({ id_producto:idp, nombre, precio, cantidad:cant });
      sel.value=""; qty.value=1; recalc();
    });
  });

  // Evitar enviar si no hay renglones (modal en vez de alert)
  document.getElementById("cuentaForm").addEventListener("submit", e=>{
    if (detalle.length===0) { e.preventDefault(); showMsg("Agrega al menos un producto."); }
  });

  // Forzar que el input fecha arranque en 'hoy'
  (function(){
    const f = document.querySelector('input[name="fecha"]');
    if (f && f.min) f.value = f.min;
  })();
</script>
</body>
</html>
