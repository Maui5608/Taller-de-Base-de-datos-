<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Añadir Cuenta – Smörgås Kaffet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --bg-sky: #9fd0ff;         /* Fondo azul suave */
      --panel-yellow: #fff59d;   /* Panel amarillo */
      --panel-yellow-soft:#fff9c4;/* Subpanel más claro */
      --primary-blue: #1e88e5;   /* Botón primario */
      --muted-gray: #6c757d;     /* Botón gris */
      --table-border: #e8eef6;
      --text-dark: #2b2d2f;
      --shadow: 0 10px 30px rgba(0,0,0,.12);
    }

    body{
      background: var(--bg-sky);
      color: var(--text-dark);
    }

    /* Panel amarillo estilo mockup */
    .wrap{
      max-width: 920px;
      margin: 48px auto;
      background: var(--panel-yellow);
      border-radius: 18px;
      box-shadow: var(--shadow);
      border: 2px solid rgba(0,0,0,.06);
      padding: 28px 26px;
    }

    .panel-soft{
      background: var(--panel-yellow-soft);
      border: 1px solid rgba(0,0,0,.05);
      border-radius: 14px;
      padding: 22px;
    }

    h3.title{
      text-align: center;
      font-weight: 700;
      margin-bottom: 16px;
      letter-spacing: .3px;
    }

    .form-label{
      font-weight: 600;
    }

    .btn-primary{
      background: var(--primary-blue);
      border-color: var(--primary-blue);
      font-weight: 600;
      border-radius: 10px;
    }
    .btn-primary:hover{ filter: brightness(.95); }

    .btn-muted{
      background: #7a7f86;
      border: none;
      color: #fff;
      font-weight: 600;
      border-radius: 10px;
    }
    .btn-muted:hover{ filter: brightness(.95); color: #fff; }

    .btn-add{
      background: #1e88e5;
      color: #fff;
      border: none;
      font-weight: 600;
      border-radius: 10px;
      padding: .47rem .9rem;
    }
    .btn-add:hover{ filter: brightness(.95); color:#fff; }

    .btn-del{
      border-radius: 8px;
    }

    .table thead th{
      background: #f7f9fc;
      font-weight: 600;
      border-bottom: 2px solid var(--table-border);
    }
    .table tbody td{
      border-top: 1px solid var(--table-border);
      vertical-align: middle;
    }

    .totals{
      font-weight: 700;
    }

    /* Radios alineados como en el mockup */
    .radios .form-check{
      margin-right: 18px;
    }

    /* Mensajes flash */
    .flash-wrap{
      max-width: 920px;
      margin: 16px auto 0;
    }
  </style>
</head>
<body>

<!-- Mensajes flash -->
<div class="flash-wrap">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show shadow-sm" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}
</div>

<div class="wrap">
  <h3 class="title">Nueva Cuenta</h3>

  <form id="formNueva" method="POST" action="{{ url_for('add') }}">
    <div class="panel-soft">

      <!-- Mesa -->
      <div class="row g-3 align-items-end">
        <div class="col-md-4">
          <label class="form-label">Mesa</label>
          <select class="form-select" name="id_mesa" required>
            <option value="" selected>Selecciona mesa</option>
            <option value="101">101</option>
            <option value="102">102</option>
            <option value="103">103</option>
            <option value="104">104</option>
            <option value="105">105</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
          </select>
        </div>

        <!-- Fecha (se muestra pequeño; si prefieres, cámbialo a hidden) -->
        <div class="col-md-3">
          <label class="form-label">Fecha</label>
          <input type="date" class="form-control" name="id_Fecha" id="id_Fecha" required>
        </div>
      </div>

      <!-- Menú -->
      <div class="mt-4">
        <label class="form-label">Menú</label>

        <!-- Línea 1 -->
        <div class="row g-2 mb-2">
          <div class="col-md-6">
            <select class="form-select sel-prod">
              <option value="" data-precio="0" selected>Especialidades de la casa</option>
              <option value="Chilaquiles verdes" data-precio="90">Chilaquiles verdes — $90</option>
              <option value="Molletes clásicos" data-precio="70">Molletes clásicos — $70</option>
              <option value="Hotcakes" data-precio="65">Hotcakes — $65</option>
            </select>
          </div>
          <div class="col-md-3">
            <input type="number" min="1" value="1" class="form-control qty" placeholder="Cantidad">
          </div>
          <div class="col-md-3 d-grid">
            <button type="button" class="btn btn-add add-line">Añadir</button>
          </div>
        </div>

        <!-- Línea 2 -->
        <div class="row g-2 mb-2">
          <div class="col-md-6">
            <select class="form-select sel-prod">
              <option value="" data-precio="0" selected>Sándwiches, Baguettes y varios</option>
              <option value="Sándwich de pavo" data-precio="55">Sándwich de pavo — $55</option>
              <option value="Baguette de jamón" data-precio="60">Baguette de jamón — $60</option>
              <option value="Wrap de pollo" data-precio="68">Wrap de pollo — $68</option>
            </select>
          </div>
          <div class="col-md-3">
            <input type="number" min="1" value="1" class="form-control qty" placeholder="Cantidad">
          </div>
            <div class="col-md-3 d-grid">
            <button type="button" class="btn btn-add add-line">Añadir</button>
          </div>
        </div>

        <!-- Línea 3 -->
        <div class="row g-2 mb-2">
          <div class="col-md-6">
            <select class="form-select sel-prod">
              <option value="" data-precio="0" selected>Paquete desayuno completo de especialidad</option>
              <option value="Paquete 1" data-precio="120">Paquete 1 — $120</option>
              <option value="Paquete 2" data-precio="135">Paquete 2 — $135</option>
              <option value="Paquete 4 desayuno completo de especialidad" data-precio="150">Paquete 4 — $150</option>
            </select>
          </div>
          <div class="col-md-3">
            <input type="number" min="1" value="1" class="form-control qty" placeholder="Cantidad">
          </div>
          <div class="col-md-3 d-grid">
            <button type="button" class="btn btn-add add-line">Añadir</button>
          </div>
        </div>

        <!-- Línea 4 -->
        <div class="row g-2 mb-3">
          <div class="col-md-6">
            <select class="form-select sel-prod">
              <option value="" data-precio="0" selected>Bebidas</option>
              <option value="Agua de sandía" data-precio="25">Agua de sandía — $25</option>
              <option value="Café Americano" data-precio="25">Café Americano — $25</option>
              <option value="Capuchino" data-precio="35">Capuchino — $35</option>
              <option value="Latte" data-precio="40">Latte — $40</option>
            </select>
          </div>
          <div class="col-md-3">
            <input type="number" min="1" value="1" class="form-control qty" placeholder="Cantidad">
          </div>
          <div class="col-md-3 d-grid">
            <button type="button" class="btn btn-add add-line">Añadir</button>
          </div>
        </div>
      </div>

      <!-- Servicio -->
      <div class="mt-3">
        <label class="form-label d-block">Servicio</label>
        <div class="radios d-flex align-items-center">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="id_modo_entrega" id="serv1" value="1" required>
            <label class="form-check-label" for="serv1">Llevar</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="id_modo_entrega" id="serv2" value="2" required>
            <label class="form-check-label" for="serv2">Comedor</label>
          </div>
        </div>
      </div>

      <!-- Tabla de pedidos -->
      <div class="card mt-3">
        <div class="card-body table-responsive p-0">
          <table class="table mb-0">
            <thead>
              <tr>
                <th style="width:70px">#</th>
                <th>Pedidos</th>
                <th style="width:120px" class="text-center">Cantidades</th>
                <th style="width:140px" class="text-end">Importe</th>
                <th style="width:120px" class="text-end">Acciones</th>
              </tr>
            </thead>
            <tbody id="tbodyItems">
              <!-- Items se insertan aquí -->
            </tbody>
            <tfoot>
              <tr class="totals">
                <td colspan="2" class="text-end">Total:</td>
                <td class="text-center" id="cellCant">0</td>
                <td class="text-end" id="cellTotal">$0.00</td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <!-- Campos ocultos requeridos por el backend -->
      <input type="hidden" name="importe_total" id="importe_total" value="0">

      <!-- Acciones -->
      <div class="row g-2 mt-3">
        <div class="col-md-6 d-grid">
          <button class="btn btn-primary py-2" type="submit">Enviar Cuenta</button>
        </div>
        <div class="col-md-6 d-grid">
          <a class="btn btn-muted py-2" href="{{ url_for('index') }}">Cancelar</a>
        </div>
      </div>

    </div>
  </form>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const tbody = document.getElementById("tbodyItems");
  const totalCell = document.getElementById("cellTotal");
  const cantCell  = document.getElementById("cellCant");
  const hiddenTotal = document.getElementById("importe_total");
  const form = document.getElementById("formNueva");

  // Default: hoy
  const fecha = document.getElementById("id_Fecha");
  if (fecha && !fecha.value) {
    const hoy = new Date().toISOString().slice(0,10);
    fecha.value = hoy;
  }

  function actualizarTotales() {
    let total = 0;
    let cantidades = 0;
    tbody.querySelectorAll("tr").forEach(tr => {
      const sub = parseFloat(tr.dataset.subtotal || "0");
      const c = parseInt(tr.dataset.cantidad || "0");
      total += sub;
      cantidades += c;
    });
    totalCell.textContent = `$${total.toFixed(2)}`;
    cantCell.textContent = `${cantidades}`;
    hiddenTotal.value = total.toFixed(2);
  }

  function addItem(nombre, precio, cant) {
    const idx = tbody.children.length + 1;
    const subtotal = precio * cant;

    const tr = document.createElement("tr");
    tr.dataset.subtotal = subtotal.toFixed(2);
    tr.dataset.cantidad = cant;

    tr.innerHTML = `
      <td>${idx}</td>
      <td>${nombre}</td>
      <td class="text-center">${cant}</td>
      <td class="text-end">$${subtotal.toFixed(2)}</td>
      <td class="text-end">
        <button type="button" class="btn btn-sm btn-outline-danger btn-del">Quitar</button>
      </td>
    `;
    tbody.appendChild(tr);
    actualizarTotales();
  }

  // Manejar clicks en todos los botones "Añadir"
  document.querySelectorAll(".add-line").forEach((btn, i) => {
    btn.addEventListener("click", () => {
      const sel = document.querySelectorAll(".sel-prod")[i];
      const qty = document.querySelectorAll(".qty")[i];

      const opt = sel.options[sel.selectedIndex];
      const nombre = opt.value;
      const precio = parseFloat(opt.dataset.precio || "0");
      const cant = parseInt(qty.value || "0");

      if (!nombre || precio <= 0 || cant <= 0) {
        alert("Selecciona un producto válido y una cantidad mayor a 0.");
        return;
      }
      addItem(nombre, precio, cant);
    });
  });

  // Quitar ítems
  tbody.addEventListener("click", (e) => {
    if (e.target.classList.contains("btn-del")) {
      e.target.closest("tr").remove();
      // Reindexar #
      [...tbody.children].forEach((tr, idx) => tr.firstElementChild.textContent = idx + 1);
      actualizarTotales();
    }
  });

  // Validación al enviar
  form.addEventListener("submit", (e) => {
    actualizarTotales();
    const total = parseFloat(hiddenTotal.value || "0");
    if (total <= 0) {
      e.preventDefault();
      alert("Agrega al menos un producto. El total debe ser mayor a 0.");
    }
  });
</script>
</body>
</html>
