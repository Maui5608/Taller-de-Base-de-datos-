<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Smörgås Kaffet – Usuarios</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --bg-sky:#9fd0ff; --panel-yellow:#fff59d; --primary-blue:#1e88e5;
      --warning-orange:#f4a261; --danger-red:#e85d5d; --text-dark:#2b2d2f;
      --shadow:0 8px 24px rgba(0,0,0,.12);
    }
    body{ background:var(--bg-sky); color:var(--text-dark); }
    .board{ max-width:980px; margin:48px auto; background:#fff; border-radius:18px; overflow:hidden;
            box-shadow:var(--shadow); border:2px solid rgba(0,0,0,.06);}
    .board__header{ background:var(--panel-yellow); padding:22px 24px 10px; text-align:center; }
    .board__title{ font-weight:700; letter-spacing:.5px; margin:0 0 10px; }
    .btn-primary{ background:var(--primary-blue); border-color:var(--primary-blue); font-weight:600; border-radius:10px; }
    .btn-del{ background:var(--danger-red); border:none; color:#fff; font-weight:700; padding:.45rem .8rem; border-radius:8px;}
    .board__body{ padding:22px 24px 28px; background:#fff; }
    .badge.bg-secondary{ font-weight:600; background:#eefffa; border:1px solid #d7e9ff; color:#fff; border-radius:999px; padding:6px 10px; }

    /* Modal con el mismo estilo */
    .modal-header{ background:var(--panel-yellow); border-bottom:1px solid rgba(0,0,0,.08); }
    .modal-title{ font-weight:700; color:#2b2d2f; }
    .btn-cancelar{ background:#e0e0e0; border:none; color:#2b2d2f; }
    .btn-confirmar{ background:var(--danger-red); border:none; }
    .modal-content{ border-radius:16px; box-shadow:var(--shadow); }
  </style>
</head>
<body>

<!-- Mensajes flash -->
<div class="container mt-3" style="max-width:980px;">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show shadow-sm" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}
</div>

<section class="board">
  <div class="board__header">
    <h2 class="board__title">Administrar usuarios</h2>
    <div class="d-flex justify-content-center align-items-center mb-2">
      <span class="text-muted">
        Usuario: <strong>{{ usuario }}</strong> — Rol: <strong>{{ rol }}</strong>
      </span>
      <a class="btn btn-sm btn-outline-dark ms-3" href="{{ url_for('logout') }}">Cerrar sesión</a>
    </div>
    <div class="d-flex justify-content-center gap-2">
      <a class="btn btn-primary" href="{{ url_for('index') }}">Volver a Ventas</a>
    </div>
  </div>

    <div class="board__body">
        <div class="table-responsive" style="max-width:900px; margin:0 auto;"></div>
      <table class="table align-middle">
        <thead>
          <tr>
            <th>ID</th>
            <th>Usuario</th>
            <th>Rol</th>
            <th>Creación</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for u in usuarios %}
          <tr>
            <td>{{ u['ID_Usuario'] }}</td>
            <td>{{ u['Nombre_Usuario'] }}</td>
            <td><span class="badge bg-secondary">{{ u['Rol_Usuario'] }}</span></td>
            <td>{{ u['Fecha_Creacion'] }}</td>
            <td>
            {% if rol == 'admin' %}
                <!-- Botón Eliminar (ya existente) -->
                <button
                type="button"
                class="btn btn-del btn-sm btn-open-modal"
                data-bs-toggle="modal"
                data-bs-target="#confirmModal"
                data-username="{{ u['Nombre_Usuario'] }}"
                data-action="{{ url_for('usuario_delete', id_usuario=u['ID_Usuario']) }}">
                Eliminar
                </button>

                <!-- NUEVO: Botón Restablecer contraseña -->
                <button
                type="button"
                class="btn btn-sm btn-outline-dark ms-1 btn-open-reset"
                data-bs-toggle="modal"
                data-bs-target="#resetModal"
                data-username="{{ u['Nombre_Usuario'] }}"
                data-action="{{ url_for('usuario_reset_password', id_usuario=u['ID_Usuario']) }}">
                Restablecer contraseña
                </button>
            {% else %}
                <span class="text-muted">Solo admin</span>
            {% endif %}
            </td>
          </tr>
          {% else %}
          <tr><td colspan="6" class="text-center text-muted py-4">No hay usuarios registrados.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</section>

<!-- Modal de confirmación -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirmar eliminación</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <p class="mb-0">
          ¿Seguro que quiere eliminar al usuario
          <strong id="modalUserName">usuario</strong>?
          <br>
          <small class="text-muted">Esta acción es permanente.</small>
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-cancelar" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-confirmar" id="btnConfirmarEliminar">Eliminar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Restablecer contraseña -->
<div class="modal fade" id="resetModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form id="resetForm" method="post">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Restablecer contraseña</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <p class="mb-2">
            Usuario: <strong id="resetUsername">—</strong>
          </p>
          <div class="mb-2">
            <label class="form-label">Nueva contraseña</label>
            <input type="password" name="new_password" class="form-control" maxlength="10" required>
            <div class="form-text">Máximo 10 caracteres.</div>
          </div>
          <div class="mb-2">
            <label class="form-label">Confirmar contraseña</label>
            <input type="password" name="confirm_password" class="form-control" maxlength="10" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-cancelar" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-confirmar">Guardar</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Form oculto para enviar el POST al confirmar -->
<form id="deleteFormHidden" method="post" style="display:none;"></form>

<!-- JS Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Referencias
  const confirmModal     = document.getElementById('confirmModal');
  const modalUserNameEl  = document.getElementById('modalUserName');
  const btnConfirmar     = document.getElementById('btnConfirmarEliminar');
  const formHidden       = document.getElementById('deleteFormHidden');

  // Variables para la acción seleccionada
  let deleteAction = '#';

  // Cuando se abre el modal, leemos los datos del botón que lo disparó
  confirmModal.addEventListener('show.bs.modal', (event) => {
    const button = event.relatedTarget; // botón .btn-open-modal
    const username = button.getAttribute('data-username');
    const action   = button.getAttribute('data-action');

    modalUserNameEl.textContent = `"${username}"`;
    deleteAction = action;
  });

  // Al confirmar, enviamos un POST a la ruta correspondiente
  btnConfirmar.addEventListener('click', () => {
    formHidden.setAttribute('action', deleteAction);
    formHidden.submit();
  });

  // Modal de restablecer contraseña
  const resetModal = document.getElementById('resetModal');
  const resetUsernameEl = document.getElementById('resetUsername');
  const resetForm = document.getElementById('resetForm');

  resetModal.addEventListener('show.bs.modal', (ev)=>{
    const btn = ev.relatedTarget; // botón .btn-open-reset
    const username = btn.getAttribute('data-username');
    const action   = btn.getAttribute('data-action');
    resetUsernameEl.textContent = username;
    resetForm.setAttribute('action', action);
    // Limpiar inputs
    resetForm.querySelector('input[name="new_password"]').value = "";
    resetForm.querySelector('input[name="confirm_password"]').value = "";
  });

</script>

</body>
</html>
